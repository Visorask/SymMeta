#!/usr/bin/env bash

# Exit codes
# 1 = Script cancelled due to no files.

### Main Variables ###

new_loc="/mnt/unionfs/bif"
local="/mnt/local/bif"
plex_dir="/opt/plex/Library/Application Support/Plex Media Server/Media/"

### End Variables ###

### Start Functions ###

arrayRead() {
readarray -t bifArray < <(fd -e bif index-sd "$plex_dir")
}

checkExist() {
if [ ${#bif_array[@]} -eq 0 ]; then
  echo "$(date "+%d.%m.%Y %T") INFO: There are ${#bif_array[@]} index-sd.bif files currently. Exiting script."
  exit 1
else
  echo "$(date "+%d.%m.%Y %T") INFO: There are currently ${#bif_array[@]} index-sd.bif files. Moving to next step."
fi
}

moveCreate() {
for index in "${bifArray[@]}"; do
  gai=$(echo $index | grep -oP '(?<=/localhost/).*(?=/Contents/)')
    echo "$(date "+%d.%m.%Y %T") INFO: Creating directory $local/Media/localhost/$gai/Contents/Indexes/"
      mkdir -p "$local/Media/localhost/$gai/Contents/Indexes/"
    echo "$(date "+%d.%m.%Y %T") INFO: Moving file from $index to $local/Media/localhost/$gai/Contents/Indexes/"
      mv "$index" "$local/Media/localhost/$gai/Contents/Indexes/"
done
}

uploadFile() {
echo "$(date "+%d.%m.%Y %T") INFO: Cloudplow is now uploading these files."
  cloudplow upload
echo "$(date "+%d.%m.%Y %T") INFO: Sleeping for 1 minute to let the mount polling catch up."
  sleep 1m
}

symlinkCreate() {
for index in "${bifAarray[@]}"; do
  gai=$(echo $index | grep -oP '(?<=/localhost/).*(?=/Contents/)')
    echo "$(date "+%d.%m.%Y %T") INFO: Creating symlink from $new_loc/Media/localhost/$gai/Contents/Indexes/index-sd.bif $index"
      ln -s "$new_loc/Media/localhost/$gai/Contents/Indexes/index-sd.bif" "$index"
done
}

### End Functions ###

### Run Functions ###

arrayRead
checkExist
moveCreate
uploadFile
symlinkCreate